import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:math';
import 'dart:developer' as developer;
import 'package:mailer/mailer.dart';
import 'package:mailer/smtp_server.dart';

class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  
  // Configura√ß√µes SMTP Brevo
  final String _brevoSmtpHost = 'smtp-relay.brevo.com';
  final int _brevoSmtpPort = 587;
  final String _brevoSmtpLogin = 'a2d962001@smtp-brevo.com';
  final String _brevoSmtpPassword = 'xsmtpsib-69983f7a36b73d3b9607f26487449ef95ff9cd9caf22b1b7abe24683131994d0-YUfpwFZ4wG2rvrKY';
  final String _remetenteEmail = 'noreply@notaok.com.br';
  final String _remetenteNome = 'NotaOK';

  // URL do backend de valida√ß√£o (voc√™ pode usar Cloud Functions ou seu pr√≥prio servidor)
  final String _validationBaseUrl = 'https://notaok.com.br/verify';

  /// Gera token seguro de 32 caracteres
  String _gerarTokenSeguro() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    final random = Random.secure();
    return List.generate(32, (_) => chars[random.nextInt(chars.length)]).join();
  }

  /// Cadastrar usu√°rio com valida√ß√£o por email
  Future<User?> cadastrarComEmail({
    required String nome,
    required String email,
    required String senha,
  }) async {
    try {
      developer.log('üöÄ [CADASTRO] Iniciando cadastro para: $email');

      // 1. Criar usu√°rio no Firebase Auth
      UserCredential userCredential = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: senha,
      );

      User? user = userCredential.user;
      if (user == null) {
        throw Exception('Erro ao criar usu√°rio no Firebase Auth');
      }

      developer.log('‚úÖ [CADASTRO] Usu√°rio criado no Firebase: ${user.uid}');

      // 2. Gerar token de valida√ß√£o
      final token = _gerarTokenSeguro();
      developer.log('üîë [TOKEN] Gerado: ${token.substring(0, 8)}...');

      // 3. Salvar dados no Firestore
      await _firestore.collection('usuarios').doc(user.uid).set({
        'nome': nome,
        'email': email,
        'email_verificado': false,
        'token_validacao': token,
        'token_expiracao': DateTime.now().add(Duration(hours: 24)).millisecondsSinceEpoch,
        'data_cadastro': FieldValue.serverTimestamp(),
      });

      developer.log('üíæ [FIRESTORE] Dados salvos para UID: ${user.uid}');

      // 4. Enviar email com link de valida√ß√£o
      await _enviarEmailValidacao(email, nome, token, user.uid);

      developer.log('‚úÖ [CADASTRO] Processo completo para: $email');
      return user;

    } catch (e, stackTrace) {
      developer.log('‚ùå [ERRO CADASTRO] $e', error: e, stackTrace: stackTrace);
      rethrow;
    }
  }

  /// Envia email de valida√ß√£o via Brevo API REST
  Future<void> _enviarEmailValidacao(String email, String nome, String token, String userId) async {
    try {
      developer.log('üìß [EMAIL SMTP] Enviando para: $email');

      // Link de valida√ß√£o
      final linkValidacao = 'https://notaok.com.br/verify?token=$token&uid=$userId';
      
      // Configurar servidor SMTP Brevo
      final smtpServer = SmtpServer(
        _brevoSmtpHost,
        port: _brevoSmtpPort,
        username: _brevoSmtpLogin,
        password: _brevoSmtpPassword,
      );

      // Criar mensagem HTML
      final message = Message()
        ..from = Address(_remetenteEmail, _remetenteNome)
        ..recipients.add(email)
        ..subject = 'üîó Confirme seu Email - NotaOK'
        ..html = """
<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; text-align: center; border-radius: 10px 10px 0 0;">
    <h1 style="color: white; margin: 0;">‚ú® Bem-vindo ao NotaOK, $nome!</h1>
  </div>
  
  <div style="padding: 40px; background: white;">
    <p style="font-size: 16px; color: #333;">Ol√°, <strong>$nome</strong>! üëã</p>
    
    <p style="font-size: 15px; color: #666; line-height: 1.6;">
      Estamos felizes em t√™-lo conosco! Para garantir a seguran√ßa da sua conta,
      clique no bot√£o abaixo para verificar seu email:
    </p>

    <div style="text-align: center; margin: 30px 0;">
      <a href="$linkValidacao" 
         style="display: inline-block; padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; text-decoration: none; border-radius: 8px; font-size: 16px; font-weight: bold;">
        ‚úÖ VERIFICAR EMAIL
      </a>
    </div>

    <p style="font-size: 13px; color: #999; text-align: center; margin-top: 20px;">
      Ou copie este link: <br>
      <span style="color: #667eea; word-break: break-all;">$linkValidacao</span>
    </p>

    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 30px; border-radius: 5px;">
      <p style="margin: 0; color: #856404; font-size: 14px;">
        ‚è∞ <strong>Aten√ß√£o:</strong> Este link expira em 24 horas.
      </p>
    </div>
  </div>

  <div style="background: #f8f9fa; padding: 20px; text-align: center; border-radius: 0 0 10px 10px;">
    <p style="margin: 0; color: #6c757d; font-size: 13px;">
      ¬© 2026 NotaOK. Todos os direitos reservados.
    </p>
  </div>
</body>
</html>
""";

      // Enviar email
      final sendReport = await send(message, smtpServer);
      developer.log('‚úÖ [EMAIL SMTP] Enviado! ID: \${sendReport.toString()}');

    } catch (e, stackTrace) {
      developer.log('‚ùå [ERRO EMAIL SMTP] $e', error: e, stackTrace: stackTrace);
      // N√£o falhar o cadastro se o email n√£o for enviado
    }
  }

  /// Valida o token e marca o email como verificado
  Future<bool> validarToken(String token, String userId) async {
    try {
      developer.log('üîç [VALIDA√á√ÉO] Validando token para UID: $userId');

      final userDoc = await _firestore.collection('usuarios').doc(userId).get();
      
      if (!userDoc.exists) {
        developer.log('‚ùå [VALIDA√á√ÉO] Usu√°rio n√£o encontrado');
        return false;
      }

      final data = userDoc.data()!;
      final tokenArmazenado = data['token_validacao'] as String?;
      final expiracao = data['token_expiracao'] as int?;

      if (tokenArmazenado == null || expiracao == null) {
        developer.log('‚ùå [VALIDA√á√ÉO] Token ou expira√ß√£o n√£o encontrados');
        return false;
      }

      // Verifica se o token est√° expirado
      if (DateTime.now().millisecondsSinceEpoch > expiracao) {
        developer.log('‚è∞ [VALIDA√á√ÉO] Token expirado');
        return false;
      }

      // Verifica se o token corresponde
      if (token != tokenArmazenado) {
        developer.log('üîê [VALIDA√á√ÉO] Token inv√°lido');
        return false;
      }

      // Marca como verificado
      await _firestore.collection('usuarios').doc(userId).update({
        'email_verificado': true,
        'data_validacao': FieldValue.serverTimestamp(),
        'token_validacao': FieldValue.delete(), // Remove o token usado
        'token_expiracao': FieldValue.delete(),
      });

      developer.log('‚úÖ [VALIDA√á√ÉO] Email verificado com sucesso!');
      return true;

    } catch (e, stackTrace) {
      developer.log('‚ùå [ERRO VALIDA√á√ÉO] $e', error: e, stackTrace: stackTrace);
      return false;
    }
  }

  /// Login do usu√°rio
  Future<User?> loginComEmail(String email, String senha) async {
    try {
      developer.log('üîë [LOGIN] Tentando login para: $email');

      UserCredential userCredential = await _auth.signInWithEmailAndPassword(
        email: email,
        password: senha,
      );

      User? user = userCredential.user;
      if (user == null) {
        throw Exception('Usu√°rio n√£o encontrado');
      }

      // Verifica se o email foi verificado no Firestore
      final userDoc = await _firestore.collection('usuarios').doc(user.uid).get();
      final emailVerificado = userDoc.data()?['email_verificado'] ?? false;

      if (!emailVerificado) {
        developer.log('‚ö†Ô∏è [LOGIN] Email n√£o verificado');
        await _auth.signOut();
        throw Exception('Por favor, verifique seu email antes de fazer login.');
      }

      developer.log('‚úÖ [LOGIN] Login bem-sucedido para: $email');
      return user;

    } catch (e, stackTrace) {
      developer.log('‚ùå [ERRO LOGIN] $e', error: e, stackTrace: stackTrace);
      rethrow;
    }
  }

  /// Logout
  Future<void> logout() async {
    await _auth.signOut();
  }

  /// Usu√°rio atual
  User? get usuarioAtual => _auth.currentUser;

  /// Stream de autentica√ß√£o
  Stream<User?> get authStateChanges => _auth.authStateChanges();
}
